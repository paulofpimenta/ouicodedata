<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-11-08T22:41:12+01:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">OuiCodeData</title><subtitle>A portal with news, tutorials and tips about GIS.</subtitle><entry><title type="html">Worldclim data with R: the right way</title><link href="http://localhost:4000/posts/worldclim-with-r/" rel="alternate" type="text/html" title="Worldclim data with R: the right way" /><published>2023-10-13T14:05:09+02:00</published><updated>2023-10-13T14:05:09+02:00</updated><id>http://localhost:4000/posts/worldclim-with-r</id><content type="html" xml:base="http://localhost:4000/posts/worldclim-with-r/"><![CDATA[<h3 id="introduction">Introduction</h3>

<p>Worldclim data is a great source of environmental data opensource data. Its a database of high spatial resolution global weather and climate data. Worldclim <a class="citation" href="#worldclim">[1]</a> is in its version 2.1 and it has climate data from 1970 to 2000. Containing several bioclimatic variables derived from monthly temperatre and rainfall values, the data is usually applied to ecology and modelling techniques. Although you can download all the data <a href="https://worldclim.org/data/index.html">here</a>, Worldclim data can also be easily downloaded using the  <code class="language-plaintext highlighter-rouge">raster</code> package with <code class="language-plaintext highlighter-rouge">R</code> using few lines of code.</p>

<p>This approach will, however , soon be deprecated due to the <a href="https://r-spatial.org/r/2022/04/12/evolution.html">retirement of rgdal, rgeos and maptools</a>. Hopefully, Worldclim is still easlly acessible. For this post, we will focus on how to extract and plot data from Worldclim, focusing on preciptation raster in Nigeria</p>

<h3 id="the-right-way">The right way</h3>

<p>Any user with litte experience with R my quickly acess the worldclim large set of raster files containing many environmental data. With the deprecation <code class="language-plaintext highlighter-rouge">rdal</code> and others, wordclim is managed by the <a href="https://cran.r-project.org/web/packages/geodata/geodata.pdf">geodata</a> package. Depending on your R versiom, you might still be able to run <code class="language-plaintext highlighter-rouge">raster</code> and <code class="language-plaintext highlighter-rouge">rgal</code> packages, but its very likelly will you find some warnings. Plus, it is better to get used to the new practices of spatial data manipulation in <code class="language-plaintext highlighter-rouge">R</code>, that is, the use of the <code class="language-plaintext highlighter-rouge">sf</code> package. Let’s start !</p>

<h3 id="set-raster-and-vector-path">Set raster and vector path</h3>

<p>We start by defining raster and vector paths. For raster data, you can set <code class="language-plaintext highlighter-rouge">raster_path = tempdir()</code> if you want to download the data into a temp folder. If not, set it to folder of preference. You can also do the same for <code class="language-plaintext highlighter-rouge">vector_output_path</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raster_path_folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tempdir</span><span class="p">()</span><span class="w"> 
</span><span class="n">vector_output_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"~/nigeria_adm2"</span><span class="w">
</span><span class="n">vector_output_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">vector_output_path</span><span class="p">,</span><span class="w"> </span><span class="s2">".zip"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="load-data-from-worldclim">Load data from worldclim</h3>

<p>Now, we use a worlclim function called <code class="language-plaintext highlighter-rouge">worldclim_country</code>. The <code class="language-plaintext highlighter-rouge">res</code> paramater is the resolution, with valid values as 10,5,2.5 and 0.5. The <code class="language-plaintext highlighter-rouge">var</code> parameter is the variable name, with valid values as <code class="language-plaintext highlighter-rouge">tmin</code>, <code class="language-plaintext highlighter-rouge">tmax</code>, <code class="language-plaintext highlighter-rouge">tavg</code>, <code class="language-plaintext highlighter-rouge">prec</code>, <code class="language-plaintext highlighter-rouge">wind</code>,
<code class="language-plaintext highlighter-rouge">vapr</code> and <code class="language-plaintext highlighter-rouge">bio</code>.</p>

<p>Using the code bellow, we chose <code class="language-plaintext highlighter-rouge">prec</code> since we are interested in precipitation data. Thus, the <code class="language-plaintext highlighter-rouge">worldclim_country</code> function will return 12 layers of raster (in a raster stack), each image representing a month of precipitation in Nigeria (NGA). We later save the coordinate system of the data for later use in line 2</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raster_stack</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">worldclim_country</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"NGA"</span><span class="p">,</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raster_path_folder</span><span class="w"> </span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="s2">"2.1"</span><span class="p">,</span><span class="n">res</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="s2">"prec"</span><span class="p">)</span><span class="w">
</span><span class="n">crs_proj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crs</span><span class="p">(</span><span class="n">raster_stack</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="download-the-shapefile">Download the shapefile</h3>

<p>You can manually download and extract data from the OCHC site. The nigeria administrative level 2 vector data is avaiable <a href="https://data.humdata.org/dataset/nigeria-admin-level-2">here</a>. Or, you can just run these two lines :</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">download.file</span><span class="p">(</span><span class="s2">"https://data.humdata.org/dataset/aac2a1d6-36c6-4f47-beee-34415742180d/resource/d7011402-0a22-4927-82eb-1359d17ff5cd/download/nigeria_admin_level_2.zip"</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">destfile</span><span class="o">=</span><span class="n">vector_output_file</span><span class="p">)</span><span class="w">
</span><span class="n">unzip</span><span class="p">(</span><span class="n">vector_output_file</span><span class="p">,</span><span class="w"> </span><span class="n">exdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector_output_path</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="read-the-downloaded-shape-file">Read the downloaded shape file</h3>

<p>If we want to plot them together, we must be sure that they belong to the same coordinate system. Let’s apply the coordinate systems saved previously in <code class="language-plaintext highlighter-rouge">crs_proj</code> and apply it to the nigeria admin level boundaries</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nigeria_vector_adm2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_sf</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">vector_output_path</span><span class="p">,</span><span class="s2">"/"</span><span class="p">,</span><span class="s2">"Nigeria_Admin_Level_2.shp"</span><span class="p">))</span><span class="w">
</span><span class="n">nigeria_vector_adm2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_transform</span><span class="p">(</span><span class="n">nigeria_vector_adm2</span><span class="p">,</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="n">raster_stack</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>All we have to do now is to set the plot to 12 subplots, using the <code class="language-plaintext highlighter-rouge">par</code> function, loop over the raster stack and plot nigeria boundaries.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set up plot area</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">))</span><span class="w">

</span><span class="c1"># Loop layers and plot</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">raster_stack</span><span class="p">[</span><span class="m">1</span><span class="p">])){</span><span class="w">
  </span><span class="n">plot</span><span class="p">(</span><span class="n">raster_stack</span><span class="p">[[</span><span class="n">i</span><span class="p">]],</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="nf">names</span><span class="p">(</span><span class="n">raster_stack</span><span class="p">[[</span><span class="n">i</span><span class="p">]]))</span><span class="w">
  </span><span class="n">plot</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">nigeria_vector_adm2</span><span class="p">),</span><span class="n">bg</span><span class="o">=</span><span class="s1">'transparent'</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lightblue"</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>And the result :</p>

<p align="center">
  <img src="/img/worldclim.png" />
</p>

<ol class="bibliography"><li><p><span id="worldclim">1. Fick SE, Hijmans RJ. WorldClim 2: new 1-km spatial resolution climate surfaces for global land areas. <i>International Journal of Climatology</i> 2017; <b>37</b>(12): 4302–4315. DOI: https://doi.org/10.1002/joc.5086.</span></p></li></ol>]]></content><author><name>Paulo Pimenta</name></author><category term="R" /><category term="Spatial data" /><summary type="html"><![CDATA[Introduction]]></summary></entry><entry><title type="html">Gender detection with Pytorch</title><link href="http://localhost:4000/posts/gender-detector-with-pytorch/" rel="alternate" type="text/html" title="Gender detection with Pytorch" /><published>2023-06-12T14:15:09+02:00</published><updated>2023-06-12T14:15:09+02:00</updated><id>http://localhost:4000/posts/gender-detector-with-pytorch</id><content type="html" xml:base="http://localhost:4000/posts/gender-detector-with-pytorch/"><![CDATA[<p>Last month I spent quite some time diving into the wonderful world of Pytorch library for deep learning. My objective is to post a series of applications with pytorch features. But for now I will focus on how to build an gender detection application with Pytorch using the webcam as input</p>

<h3 id="get-the-dataset-first-but-which-one-and-why-">Get the dataset first. But which one and why ?</h3>

<p>It is not difficult to find some available datasets containing human faces. The sources are numerous : The <a href="https://susanqq.github.io/UTKFace/">UTKFace</a>; the famous <a href="https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html">CelebA</a> database with more than 200 thousand faces of celebrities; <a href="https://github.com/microsoft/DigiFace1M">DigiFace</a> with its 1.2 million free from privacy violations images, and so on. A good list can be found <a href="https://datagen.tech/blog/face-datasets/">here</a>. In this post, I decided to work with a dataset this dataset <a href="https://www.kaggle.com/datasets/ashwingupta3012/male-and-female-faces-dataset/data">here</a> for three reasons. The first is that this dataset, as many others, has  with a public domain license, but is also very used in kaggle notebooks. The second reason, is how the data is presented and organized.  The other datasets have either spreadsheets with annotations containing name files and the classes thar each file belong to, or, in some cases, classes are not divided by folders. Since my object is to load data from custom dataset (next section :-)), I wanted a dataset that was more structured into folders and classes. And the final reason is the image quality : this dataset does not contain high quality images. Which is is quite well, considering that our input images will come from web cam, that usually have low resolution images. Thus, in this case, a model trained with nice and artistic images may not reflect the context of the application.</p>

<h3 id="how-to-work-with-data-with-pytorch">How to work with data with Pytorch</h3>

<p>Pytorch library is a very rich framework with libraries that fit your need according to the type of problem you want to solve. For instance,<code class="language-plaintext highlighter-rouge">Torchaudio</code> for audio recognition, <code class="language-plaintext highlighter-rouge">Torchvision</code> for images, <code class="language-plaintext highlighter-rouge">Torchtext</code>for NLP, <code class="language-plaintext highlighter-rouge">Torchgeo</code> for satellite images, and so on. Since our problem is image classification, we will use the <code class="language-plaintext highlighter-rouge">Torchvision</code> library. This library has has a very straight forward (but flexible) process about reading data: your first (1) create your dataset, than you transform (2) the data, augment (3) it if necessary, and finally, add it to a dataloader (4) before training. This process can be illustrated by the image bellow:</p>

<p align="center">
  <img src="/img/basic_dataloader_pipeline.png" />
  Source https://arcwiki.rs.gsu.edu
</p>

<p>Before we talk about how to load data with Pytorch, I will briefly present the application and the neural network architecture used in this work</p>

<h3 id="application-architecture">Application architecture</h3>

<p>As stated before, the idea is to have a web application that takes live screenshots from the user’s webcam performs live predictions as a result. The application was built according to the following schema :</p>

<p align="center">
  <img src="/img/app1_architecture.png" width="500" />
  <p align="center"><strong>Application main architecture</strong></p>
</p>

<p>In this post, we will focus only on the Pytorch side, which is the aim of this post. However, it is import to keep in mind that models applied to real cases might suffer from some sort of technical limitation. These limitations include, but not limited to, poor infrastructure resources, nature of training data, model complexity or even, deployment issues. We will come to that later</p>

<h3 id="neural-network-architecture">Neural network architecture</h3>

<p>The architecture of a neural network is core of deep learning application, since it can provide the most optimized way to deal if the data thought the many layers of input neurons. Our architecture is the same used in <a class="citation" href="#Levi2015AgeAG">[1]</a></p>

<h3 id="building-your-custom-set">Building your custom set</h3>

<p><code class="language-plaintext highlighter-rouge">Torchvision</code> is a package in the PyTorch library containing computer-vision models, datasets, and image transformations. A famous dataset in the domain of Machine Learning (the MNIST) dataset, could be easily load like this :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">torchvision</span>
<span class="kn">import</span> <span class="n">torchvision.datasets</span> <span class="k">as</span> <span class="n">datasets</span>

<span class="c1"># Load train set
</span><span class="n">mnist_trainset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">.</span><span class="nc">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="sh">'</span><span class="s">./data</span><span class="sh">'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="c1"># Load test set
</span><span class="n">mnist_testset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">.</span><span class="nc">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="sh">'</span><span class="s">./data</span><span class="sh">'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<p>Notice that <code class="language-plaintext highlighter-rouge">datasets.MNIST</code> is already provided out of the box to us. But in real data problems, that is usually not the case. Thus we will have to create our own datataset. But, as I said, Pytorch makes it quite easy :-)</p>

<p>In order to create your own data set, you must create a class that inhertis the <code class="language-plaintext highlighter-rouge">torch.utils.data.Dataset</code> abstract class. Our custom dataset class must also override the methods <code class="language-plaintext highlighter-rouge">__len__</code>  and <code class="language-plaintext highlighter-rouge">__getitem__</code>. They are respectively responsible for returning the size of the dataset and provide support for the indexing samples.</p>

<p>Let’s create our custom dataset called GenderDataSet as follows :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GenderDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image_paths</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">image_paths</span> <span class="o">=</span> <span class="n">image_paths</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="n">self</span><span class="p">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">image_paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># Select images by path and indexes
</span>        <span class="n">image_filepath</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="nf">read_image</span><span class="p">(</span><span class="n">image_filepath</span><span class="p">)</span>
        <span class="c1"># Create dictionary for class indexes
</span>        <span class="n">idx_to_class</span> <span class="o">=</span>  <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">classes</span><span class="p">)}</span>
        <span class="n">class_to_idx</span> <span class="o">=</span>  <span class="p">{</span><span class="n">value</span><span class="p">:</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">idx_to_class</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="c1"># Replace split char by '/' on unix systems
</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">image_filepath</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\\</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">class_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="c1"># Appy transform if there any is provided
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="c1"># Return image and its label
</span>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</code></pre></div></div>
<p>When we instantiate our dataset, we added 3 more class attributes : <code class="language-plaintext highlighter-rouge">image_paths</code>, <code class="language-plaintext highlighter-rouge">classes</code> and <code class="language-plaintext highlighter-rouge">transform</code>. Remember about why I chose this dataset ? Since the dataset contains folders per class, and each class has a <code class="language-plaintext highlighter-rouge">train</code> and <code class="language-plaintext highlighter-rouge">test</code> folder, all we have to do is to point where the train and test folders are. That implementation will take care of of rest, for each class present in the root folder :-)</p>

<p>So we instantiate the model <a class="citation" href="#ruby">[2]</a>.</p>

<p>#  Instantiating model
    conv_net = ConvNet()
    model = ConvolutionalNeuralNet(conv_net)
    print(conv_net)</p>

<h4 id="references">References</h4>

<ol class="bibliography"><li><p><span id="Levi2015AgeAG">1. Levi G, Hassner T. Age and gender classification using convolutional neural networks. <i>2015 IEEE Conference on Computer Vision and Pattern Recognition Workshops (CVPRW)</i> 2015: 34–42.</span></p></li>
<li><p><span id="ruby">2. Flanagan D, Matsumoto Y. <i>The Ruby Programming Language</i>. O’Reilly Media, 2008.</span></p></li></ol>]]></content><author><name>Paulo Pimenta</name></author><category term="Deep Learning" /><category term="Pytorch" /><summary type="html"><![CDATA[Last month I spent quite some time diving into the wonderful world of Pytorch library for deep learning. My objective is to post a series of applications with pytorch features. But for now I will focus on how to build an gender detection application with Pytorch using the webcam as input]]></summary></entry><entry><title type="html">Bicycle Accidents in Paris</title><link href="http://localhost:4000/posts/bicycle-accidents-in-france/" rel="alternate" type="text/html" title="Bicycle Accidents in Paris" /><published>2023-06-10T11:30:42+02:00</published><updated>2023-06-10T11:30:42+02:00</updated><id>http://localhost:4000/posts/bicycle-accidents-in-france</id><content type="html" xml:base="http://localhost:4000/posts/bicycle-accidents-in-france/"><![CDATA[<p>You’ll find this post in your <code class="language-plaintext highlighter-rouge">_posts</code> directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different ways, but the most common way is to run <code class="language-plaintext highlighter-rouge">jekyll serve</code>, which launches a web server and auto-regenerates your site when a file is updated.</p>

<h3 id="1-import-files-from-google-drive-and-extract-them-into-data-folder">1. Import files from Google Drive and extract them into data folder</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">gdown</span>
<span class="c1"># Google drive public shared folder ID
</span><span class="nb">id</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1vdm8b0ewDslPVvubA8emwDYHUGtwx5pT</span><span class="sh">"</span>
<span class="n">gdown</span><span class="p">.</span><span class="nf">download_folder</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">../data</span><span class="sh">"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_cookies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['../data\\bike_data.7z']
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">py7zr</span>
<span class="c1"># Extract files from 7zip file
</span><span class="k">with</span> <span class="n">py7zr</span><span class="p">.</span><span class="nc">SevenZipFile</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/bike_data.7z</span><span class="sh">'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
    <span class="n">z</span><span class="p">.</span><span class="nf">extractall</span><span class="p">(</span><span class="sh">"</span><span class="s">../data</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="2-read-files">2. Read files</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">warnings</span>
<span class="n">warnings</span><span class="p">.</span><span class="nf">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">ignore</span><span class="sh">'</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="nb">FutureWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/accidentsVelo.csv</span><span class="sh">'</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Num_Acc</th>
      <th>date</th>
      <th>an</th>
      <th>mois</th>
      <th>jour</th>
      <th>hrmn</th>
      <th>dep</th>
      <th>com</th>
      <th>lat</th>
      <th>long</th>
      <th>...</th>
      <th>secuexist</th>
      <th>equipement</th>
      <th>obs</th>
      <th>obsm</th>
      <th>choc</th>
      <th>manv</th>
      <th>vehiculeid</th>
      <th>typevehicules</th>
      <th>manoeuvehicules</th>
      <th>numVehicules</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>200500000030</td>
      <td>2005-01-13</td>
      <td>2005</td>
      <td>janvier</td>
      <td>jeudi</td>
      <td>19:45</td>
      <td>62</td>
      <td>62331</td>
      <td>50.3</td>
      <td>2.84</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>8.0</td>
      <td>11.0</td>
      <td>200500000030B02</td>
      <td>18</td>
      <td>17</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>200500000034</td>
      <td>2005-01-19</td>
      <td>2005</td>
      <td>janvier</td>
      <td>mercredi</td>
      <td>10:45</td>
      <td>62</td>
      <td>62022</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>200500000034B02</td>
      <td>10</td>
      <td>15</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>200500000078</td>
      <td>2005-01-26</td>
      <td>2005</td>
      <td>janvier</td>
      <td>mercredi</td>
      <td>13:15</td>
      <td>02</td>
      <td>02173</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>2</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>200500000078B02</td>
      <td>7</td>
      <td>15</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>200500000093</td>
      <td>2005-01-03</td>
      <td>2005</td>
      <td>janvier</td>
      <td>lundi</td>
      <td>13:30</td>
      <td>02</td>
      <td>02810</td>
      <td>49.255</td>
      <td>3.094</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>21.0</td>
      <td>200500000093B02</td>
      <td>7</td>
      <td>21</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>200500000170</td>
      <td>2005-01-29</td>
      <td>2005</td>
      <td>janvier</td>
      <td>samedi</td>
      <td>18:30</td>
      <td>76</td>
      <td>76196</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>9</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>200500000170A01</td>
      <td>10</td>
      <td>2</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 39 columns</p>
</div>

<h3 id="3-some-columns-have-mixed-type-values-lets-start-by-removing-nas-first-on-lat-and-long-columns-only">3. Some columns have mixed type values. Lets start by removing NA’s first on lat and long columns only</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">num_rows</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">].</span><span class="nf">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">long</span><span class="sh">"</span><span class="p">].</span><span class="nf">notna</span><span class="p">())]</span>
<span class="n">num_rows_not_na</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">----</span><span class="se">\n</span><span class="s">Removed NA</span><span class="sh">'</span><span class="s">s rows : %d</span><span class="se">\n</span><span class="s">----</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_rows</span> <span class="o">-</span><span class="n">num_rows_not_na</span><span class="p">)</span> <span class="p">)</span>
<span class="n">df</span><span class="p">[[</span><span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">long</span><span class="sh">"</span><span class="p">]].</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>----
Removed NA's rows : 268
----
&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 74490 entries, 0 to 74757
Data columns (total 2 columns):
 #   Column  Non-Null Count  Dtype 
---  ------  --------------  ----- 
 0   lat     74490 non-null  object
 1   long    74490 non-null  object
dtypes: object(2)
memory usage: 1.7+ MB
</code></pre></div></div>

<h3 id="4-convert-lat-and-long-cols-to-float">4. Convert lat and long cols to float</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)))</span>
<span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">long</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">long</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)))</span>

<span class="n">df</span><span class="p">[[</span><span class="sh">"</span><span class="s">lat</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">long</span><span class="sh">"</span><span class="p">]].</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 74490 entries, 0 to 74757
Data columns (total 2 columns):
 #   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
 0   lat     74490 non-null  float64
 1   long    74490 non-null  float64
dtypes: float64(2)
memory usage: 1.7 MB
</code></pre></div></div>

<h3 id="5-checking-zeros-on-lat-and-long-cols-and-total-number-of-cols">5. Checking zeros on lat and long cols and total number of cols</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">count_lat</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">count_long</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">long</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rows</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">lat_with_zero</span><span class="sh">"</span><span class="p">:[</span><span class="n">count_lat</span><span class="p">],</span> <span class="sh">"</span><span class="s">long_with_zero</span><span class="sh">"</span><span class="p">:[</span><span class="n">count_long</span><span class="p">],</span><span class="sh">"</span><span class="s">Total number of rows</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">rows</span><span class="p">]})</span>
<span class="n">results</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lat_with_zero</th>
      <th>long_with_zero</th>
      <th>Total number of rows</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>42084</td>
      <td>43131</td>
      <td>74490</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="6-remove-rows-where-lat-and-long-columns-are-not-0">6. Remove rows where lat and long columns are not 0</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">long</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)].</span><span class="nf">copy</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Non zero coordinates data frame has %d rows</span><span class="sh">"</span> <span class="o">%</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Non zero coordinates data frame has 31355 rows
</code></pre></div></div>

<h3 id="7-convert-to-a-proper-geodataframe">7. Convert to a proper geodataframe</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">geopandas</span> <span class="k">as</span> <span class="n">gp</span>
<span class="c1"># Convert longitude and latitude to a geometric Point object
</span><span class="n">points_gdf</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">gp</span><span class="p">.</span><span class="nf">points_from_xy</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">df_filtered</span><span class="p">.</span><span class="nb">long</span><span class="p">))</span>
<span class="c1"># Convert DataFrame to GeoDataFrame
</span><span class="n">points_gdf</span> <span class="o">=</span> <span class="n">points_gdf</span><span class="p">.</span><span class="nf">set_crs</span><span class="p">(</span><span class="sh">'</span><span class="s">epsg:4326</span><span class="sh">'</span><span class="p">)</span>
<span class="n">points_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="sh">'</span><span class="s">equal</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">points_gdf</span><span class="p">.</span><span class="n">crs</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>epsg:4326
</code></pre></div></div>

<p><img src="../../img/bike/output_14_1.png" alt="png" /></p>

<h4 id="its-seems-the-coordinates-are-inverted-lets-fix-this">Its seems the coordinates are inverted, let’s fix this</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert longitude and latitude to a geometric Point object
</span><span class="n">points_gdf</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">gp</span><span class="p">.</span><span class="nf">points_from_xy</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="nb">long</span><span class="p">,</span> <span class="n">df_filtered</span><span class="p">.</span><span class="n">lat</span><span class="p">))</span>
<span class="c1"># Convert DataFrame to GeoDataFrame
</span><span class="n">points_gdf</span> <span class="o">=</span> <span class="n">points_gdf</span><span class="p">.</span><span class="nf">set_crs</span><span class="p">(</span><span class="sh">'</span><span class="s">epsg:4326</span><span class="sh">'</span><span class="p">).</span><span class="nf">to_crs</span><span class="p">(</span><span class="sh">'</span><span class="s">epsg:27561</span><span class="sh">'</span><span class="p">)</span>
<span class="n">points_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">points_gdf</span><span class="p">.</span><span class="n">crs</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>epsg:27561
</code></pre></div></div>

<p><img src="../../img/bike/output_16_1.png" alt="png" /></p>

<h3 id="8-plot-france-department-limits-and-bike-accident-points">8. Plot France department limits and bike accident points</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">france_gdf</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="sh">"</span><span class="s">../data/france_dep.geojson</span><span class="sh">"</span><span class="p">)</span>
<span class="n">france_gdf</span> <span class="o">=</span> <span class="n">france_gdf</span><span class="p">.</span><span class="nf">to_crs</span><span class="p">(</span><span class="sh">'</span><span class="s">epsg:27561</span><span class="sh">'</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">points_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">france_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_18_0.png" alt="png" /></p>

<h3 id="and-we-grab-and-plot-only-the-points-inside-france-and-plot-bicycle-accident-points-together">And we grab and plot only the points inside France and plot bicycle accident points together</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">points_within</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">points_gdf</span><span class="p">,</span><span class="n">france_gdf</span><span class="p">,</span><span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ax</span> <span class="o">=</span> <span class="n">points_within</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">france_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_21_0.png" alt="png" /></p>

<h4 id="9-checking-if-the-gravity-of-the-accident-can-be-spatially-explained">9. Checking if the gravity of the accident can be spatially explained</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>


<span class="n">points_within_grav_1</span> <span class="o">=</span> <span class="n">points_within</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">points_within</span><span class="p">[</span><span class="sh">'</span><span class="s">grav</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">points_within_grav_1</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Low</span><span class="sh">"</span><span class="p">)</span>

<span class="n">points_within_grav_2</span> <span class="o">=</span> <span class="n">points_within</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">points_within</span><span class="p">[</span><span class="sh">'</span><span class="s">grav</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">points_within_grav_2</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">yellow</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Mild</span><span class="sh">"</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">sharex</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">points_within_grav_3</span> <span class="o">=</span> <span class="n">points_within</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">points_within</span><span class="p">[</span><span class="sh">'</span><span class="s">grav</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">points_within_grav_3</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">High</span><span class="sh">"</span><span class="p">)</span>

<span class="n">points_within_grav_4</span> <span class="o">=</span> <span class="n">points_within</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">points_within</span><span class="p">[</span><span class="sh">'</span><span class="s">grav</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">points_within_grav_4</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Very high</span><span class="sh">"</span><span class="p">)</span>

<span class="n">fig</span><span class="p">.</span><span class="nf">set_size_inches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="n">gravity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Low</span><span class="sh">"</span><span class="p">:</span><span class="nf">len</span><span class="p">(</span><span class="n">points_within_grav_1</span><span class="p">),</span>
                                <span class="sh">'</span><span class="s">Mild</span><span class="sh">'</span><span class="p">:</span><span class="nf">len</span><span class="p">(</span><span class="n">points_within_grav_2</span><span class="p">),</span>
                                <span class="sh">"</span><span class="s">High</span><span class="sh">"</span><span class="p">:</span><span class="nf">len</span><span class="p">(</span><span class="n">points_within_grav_3</span><span class="p">),</span>
                                <span class="sh">"</span><span class="s">Very High</span><span class="sh">"</span><span class="p">:</span><span class="nf">len</span><span class="p">(</span><span class="n">points_within_grav_4</span><span class="p">)</span>
                                <span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="sh">'</span><span class="s">gravity</span><span class="sh">'</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Ploting also a bar plot
</span><span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gravity_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">gravity</span><span class="sh">'</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">yellow</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_23_0.png" alt="png" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: xlabel='gravity', ylabel='count'&gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_23_2.png" alt="png" /></p>

<h5 id="despite-the-fact-that-the-number-of-accidents-informed-as-very-high-gravity-are-higher-than-others-it-seems-that-all-accidents-are-spatially-well-distributed-across-the-country-it-is-also-evident-that-the-number-of-accidents-are-concentrated-in-certain-areas-still-the-gravity-of-an-accident-may-also-be-subjective-or-not-well-informed-in-many-cases-since-we-are-interested-in-where-the-accidents-are-occurring-lets-instead-check-the-density-of-accidents-by-region-population-no-matter-the-accidents-gravity">Despite the fact that the number of accidents informed as ‘very high’ gravity are higher than others, it seems that all accidents are spatially well distributed across the country. It is also evident that the number of accidents are concentrated in certain areas. Still, the gravity of an accident may also be subjective (or not well informed) in many cases. Since we are interested in where the accidents are occurring, let’s instead check the density of accidents by region population, no matter the accident’s gravity</h5>

<h4 id="10-merge-accidents-with-department-population">10. Merge accidents with department population</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accidents_by_department</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accidents_by_department</span> <span class="o">=</span> <span class="n">points_gdf</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">france_gdf</span><span class="p">,</span><span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>
<span class="n">accidents_by_department</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_27_1.png" alt="png" /></p>

<h3 id="and-plot-accidents-by-gravity-and-by-department">and plot accidents by gravity and by department</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accidents_by_department_acc</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>

<span class="c1"># Select relevelant columns and initialize a col, since grav contains numbers from 1 to 4
</span><span class="n">accidents_by_department_acc</span> <span class="o">=</span> <span class="n">accidents_by_department</span><span class="p">[[</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">geometry</span><span class="sh">'</span><span class="p">]]</span>
<span class="n">accidents_by_department_acc</span><span class="p">[</span><span class="sh">'</span><span class="s">total_acc</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Agregate (group) the sum of accidents (points) by deparment column, resulting in 96 multipoints rows per department
</span><span class="n">accidents_by_region</span> <span class="o">=</span> <span class="n">accidents_by_department_acc</span><span class="p">.</span><span class="nf">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># Remove index field names
</span><span class="n">france_gdf</span><span class="o">=</span><span class="n">france_gdf</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">france_gdf</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>
<span class="n">accidents_by_region</span><span class="o">=</span><span class="n">accidents_by_region</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">accidents_by_region</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>

<span class="c1"># Merge france admin boundries with the previous aggregated data containing the sum
</span><span class="n">departments_by_accidents</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">france_gdf</span><span class="p">,</span><span class="n">accidents_by_region</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">inner</span><span class="sh">"</span><span class="p">,</span><span class="n">predicate</span><span class="o">=</span><span class="sh">"</span><span class="s">intersects</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Define a palette of colors
</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">colors</span><span class="p">.</span><span class="n">LinearSegmentedColormap</span><span class="p">.</span><span class="nf">from_list</span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">yellow</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">orange</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># Plot using quantiles as scheme
</span><span class="n">departments_by_accidents</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="sh">'</span><span class="s">total_acc</span><span class="sh">'</span><span class="p">,</span><span class="n">scheme</span><span class="o">=</span><span class="sh">'</span><span class="s">quantiles</span><span class="sh">'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Number of accidents by gravity and department</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Other scheme possibilities
# boxplot', 'equalinterval', 'fisherjenks', 'fisherjenkssampled', 'headtailbreaks', 'jenkscaspall', 'jenkscaspallforced', 
#'jenkscaspallsampled', 'maxp', 'maximumbreaks', 'naturalbreaks', 'quantiles', 'percentiles', 'prettybreaks', 'stdmean', 'userdefined'
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\Projects\venvs\work2\lib\site-packages\geopandas\geodataframe.py:1538: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  super().__setitem__(key, value)
</code></pre></div></div>

<p><img src="../../img/bike/output_30_1.png" alt="png" /></p>

<h3 id="quantile-classification-is-well-suited-to-linearly-evenly-distributed-data-since-we-can-have-the-same-number-of-features-or-values-in-each-class-however-the-resulting-map-can-often-be-misleading-when-the-data-is-not-evenly-distributed-which-is-precisely-our-case-">Quantile classification is well suited to linearly (evenly) distributed data, since we can have the same number of features or values in each class. However, the resulting map can often be misleading when the data is not evenly distributed, which is precisely our case :</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">displot</span><span class="p">(</span><span class="n">departments_by_accidents</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">total_acc</span><span class="sh">"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">kde</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\Projects\venvs\work2\lib\site-packages\seaborn\axisgrid.py:118: UserWarning: The figure layout has changed to tight
  self._figure.tight_layout(*args, **kwargs)





&lt;seaborn.axisgrid.FacetGrid at 0x251b59df850&gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_32_2.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">departments_by_accidents</span><span class="p">[[</span><span class="sh">"</span><span class="s">nom</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">total_acc</span><span class="sh">"</span><span class="p">]].</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">"</span><span class="s">total_acc</span><span class="sh">"</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nom</th>
      <th>total_acc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>36</th>
      <td>Paris</td>
      <td>5001</td>
    </tr>
    <tr>
      <th>82</th>
      <td>Maine-et-Loire</td>
      <td>994</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Ille-et-Vilaine</td>
      <td>892</td>
    </tr>
    <tr>
      <th>54</th>
      <td>Gironde</td>
      <td>704</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Pyrénées-Atlantiques</td>
      <td>703</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>81</th>
      <td>Lot</td>
      <td>56</td>
    </tr>
    <tr>
      <th>48</th>
      <td>Corse-du-Sud</td>
      <td>49</td>
    </tr>
    <tr>
      <th>95</th>
      <td>Territoire de Belfort</td>
      <td>38</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Lozère</td>
      <td>37</td>
    </tr>
    <tr>
      <th>50</th>
      <td>Creuse</td>
      <td>24</td>
    </tr>
  </tbody>
</table>
<p>96 rows × 2 columns</p>
</div>

<h4 id="this-map-would-reflect-better-the-reality-of-our-data-">This map would reflect better the reality of our data :</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot using without quantilles
</span><span class="n">departments_by_accidents</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="sh">'</span><span class="s">total_acc</span><span class="sh">'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">shrink</span><span class="sh">"</span><span class="p">:.</span><span class="mi">77</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">%g</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Accidents</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">pad</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="c1">#"ticks" : legend_intervals
</span>                <span class="p">});</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Number of accidents by department</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_35_0.png" alt="png" /></p>

<h4 id="11-by-using-equal-intervals-the-total-number-of-accidents-in-paris-is-way-higher-than-in-most-regions-of-france-lets-make-the-same-plot-by-using-region-population-instead">11. By using equal intervals, the total number of accidents in Paris is way higher than in most regions of france. Let’s make the same plot by using region population instead</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Removing spaces and upper cases from cols of both dataframes
</span><span class="n">accidents_by_region</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span><span class="sh">''</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">accidents_by_region</span><span class="p">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">accidents_by_department</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span><span class="sh">''</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">accidents_by_department</span><span class="p">.</span><span class="n">columns</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="load-population-data">Load population data</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">population</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_excel</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/TCRD_004.xlsx</span><span class="sh">'</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">population_filtered</span> <span class="o">=</span> <span class="n">population</span><span class="p">[[</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">2023 (p)</span><span class="sh">'</span><span class="p">]].</span><span class="nf">copy</span><span class="p">().</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">2023 (p)</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">pop_2023</span><span class="sh">'</span><span class="p">})</span>
<span class="n">population_filtered</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nom</th>
      <th>pop_2023</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>01</th>
      <td>Ain</td>
      <td>671937</td>
    </tr>
    <tr>
      <th>02</th>
      <td>Aisne</td>
      <td>522791</td>
    </tr>
    <tr>
      <th>03</th>
      <td>Allier</td>
      <td>332443</td>
    </tr>
    <tr>
      <th>04</th>
      <td>Alpes-de-Haute-Provence</td>
      <td>166654</td>
    </tr>
    <tr>
      <th>05</th>
      <td>Hautes-Alpes</td>
      <td>139942</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>91</th>
      <td>Essonne</td>
      <td>1316053</td>
    </tr>
    <tr>
      <th>92</th>
      <td>Hauts-de-Seine</td>
      <td>1642002</td>
    </tr>
    <tr>
      <th>93</th>
      <td>Seine-Saint-Denis</td>
      <td>1682806</td>
    </tr>
    <tr>
      <th>94</th>
      <td>Val-de-Marne</td>
      <td>1426748</td>
    </tr>
    <tr>
      <th>95</th>
      <td>Val-d'Oise</td>
      <td>1274374</td>
    </tr>
  </tbody>
</table>
<p>96 rows × 2 columns</p>
</div>

<h4 id="plot-the-number-of-accidents-per-1000-habitanes-per-department">Plot the number of accidents per 1000 habitanes per department</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">region_by_accidents_pop2023</span> <span class="o">=</span> <span class="n">departments_by_accidents</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">population_filtered</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">)</span>
<span class="n">region_by_accidents_pop2023</span><span class="p">[</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_by_accidents_pop2023</span><span class="p">[</span><span class="sh">'</span><span class="s">total_acc</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">region_by_accidents_pop2023</span><span class="p">[</span><span class="sh">'</span><span class="s">pop_2023</span><span class="sh">'</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="n">region_by_accidents_pop2023</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">]).</span><span class="nf">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">region_by_accidents_pop2023</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">shrink</span><span class="sh">"</span><span class="p">:.</span><span class="mi">77</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">%g</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Accidents per 1k hab</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">pad</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">ticks</span><span class="sh">"</span> <span class="p">:</span> <span class="p">[</span><span class="nf">min</span><span class="p">(</span><span class="n">region_by_accidents_pop2023</span><span class="p">[</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">]),</span>
                               <span class="nf">max</span><span class="p">(</span><span class="n">region_by_accidents_pop2023</span><span class="p">[</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> 
                               <span class="nf">max</span><span class="p">(</span><span class="n">region_by_accidents_pop2023</span><span class="p">[</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">])]</span>
                <span class="p">})</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_41_1.png" alt="png" /></p>

<h4 id="12-check-if-the-cyclable-rods-can-provide-more-info">12. Check if the cyclable rods can provide more info</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pistes_cyclable</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="sh">"</span><span class="s">../data/france-20230901.geojson</span><span class="sh">"</span><span class="p">)</span>
<span class="n">pistes_cyclable</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">.</span><span class="nf">to_crs</span><span class="p">(</span><span class="sh">'</span><span class="s">epsg:27561</span><span class="sh">'</span><span class="p">)</span>
<span class="n">pistes_cyclable</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_43_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pistes_cyclable</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_local</th>
      <th>id_osm</th>
      <th>num_iti</th>
      <th>code_com_d</th>
      <th>ame_d</th>
      <th>regime_d</th>
      <th>sens_d</th>
      <th>largeur_d</th>
      <th>local_d</th>
      <th>statut_d</th>
      <th>...</th>
      <th>revet_g</th>
      <th>access_ame</th>
      <th>date_maj</th>
      <th>trafic_vit</th>
      <th>lumiere</th>
      <th>d_service</th>
      <th>source</th>
      <th>project_c</th>
      <th>ref_geo</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>geovelo_967104105_65226</td>
      <td>967104105</td>
      <td>NaN</td>
      <td>65226</td>
      <td>VOIE VERTE</td>
      <td>AUTRE</td>
      <td>UNIDIRECTIONNEL</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>EN SERVICE</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-07-25</td>
      <td>5.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Les contributeurs OpenStreetmap</td>
      <td>4326</td>
      <td>OpenStreetmap</td>
      <td>LINESTRING (411941.578 -496613.093, 411959.247...</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 28 columns</p>
</div>

<h1 id="check-some-colums-and-unique-values">Check some colums and unique values</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="n">sens_d</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">sens_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="n">revet_g</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">revet_g</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="n">access_ame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">access_ame</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="n">lumiere</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Series</span><span class="p">(</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">lumiere</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_unique</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">track_type</span><span class="sh">'</span><span class="p">:</span> <span class="n">ame</span><span class="p">,</span> <span class="sh">'</span><span class="s">track_direction</span><span class="sh">'</span><span class="p">:</span><span class="n">sens_d</span><span class="p">,</span><span class="sh">'</span><span class="s">track_material</span><span class="sh">'</span><span class="p">:</span><span class="n">revet_g</span><span class="p">,</span><span class="sh">'</span><span class="s">track_acess</span><span class="sh">'</span><span class="p">:</span><span class="n">access_ame</span><span class="p">,</span><span class="sh">'</span><span class="s">lumiere</span><span class="sh">'</span><span class="p">:</span><span class="n">lumiere</span><span class="p">})</span>
<span class="n">df_unique</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>track_type</th>
      <th>track_direction</th>
      <th>track_material</th>
      <th>track_acess</th>
      <th>lumiere</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>VOIE VERTE</td>
      <td>UNIDIRECTIONNEL</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AUTRE</td>
      <td>BIDIRECTIONNEL</td>
      <td>LISSE</td>
      <td>VELO DE ROUTE</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AUCUN</td>
      <td>NaN</td>
      <td>RUGUEUX</td>
      <td>ROLLER</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AMENAGEMENT MIXTE PIETON VELO HORS VOIE VERTE</td>
      <td>NaN</td>
      <td>MEUBLE</td>
      <td>VTC</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BANDE CYCLABLE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>VTT</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>PISTE CYCLABLE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>COULOIR BUS+VELO</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>GOULOTTE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>CHAUSSEE A VOIE CENTRALE BANALISEE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>ACCOTEMENT REVETU HORS CVCB</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>DOUBLE SENS CYCLABLE BANDE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11</th>
      <td>VELO RUE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>12</th>
      <td>DOUBLE SENS CYCLABLE PISTE</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>13</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>

<h1 id="plot-proportions-of-na-for-each-col">Plot proportions of NA for each col</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">null_track_type_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>
<span class="n">not_null_track_type_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>

<span class="n">null_track_direction_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">sens_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>
<span class="n">not_null_track_direction_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">sens_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>

<span class="n">null_track_material_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">revet_g</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>
<span class="n">not_null_track_material_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">revet_g</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>

<span class="n">null_track_acess_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">access_ame</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>
<span class="n">not_null_track_acess_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">access_ame</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>

<span class="n">null_lumiere_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">lumiere</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>
<span class="n">not_null_lumiere_freq</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">lumiere</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">();</span>

<span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">Col</span><span class="sh">'</span> <span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">Track type</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Track dir</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Track material</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Track acess</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Lumiere</span><span class="sh">'</span><span class="p">],</span>
                     <span class="sh">'</span><span class="s">NA</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">null_track_type_freq</span><span class="p">,</span><span class="n">null_track_direction_freq</span><span class="p">,</span><span class="n">null_track_material_freq</span><span class="p">,</span><span class="n">null_track_acess_freq</span><span class="p">,</span><span class="n">null_lumiere_freq</span><span class="p">],</span>
                     <span class="sh">'</span><span class="s">Not NA</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">not_null_track_type_freq</span><span class="p">,</span><span class="n">not_null_track_direction_freq</span><span class="p">,</span><span class="n">not_null_track_material_freq</span><span class="p">,</span><span class="n">not_null_track_acess_freq</span><span class="p">,</span><span class="n">not_null_lumiere_freq</span><span class="p">]})</span>

<span class="n">stats</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Col</span><span class="sh">'</span><span class="p">)</span>

<span class="n">stats</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Col</th>
      <th>NA</th>
      <th>Not NA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Track type</td>
      <td>13</td>
      <td>293803</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Track dir</td>
      <td>61</td>
      <td>293755</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Track material</td>
      <td>110912</td>
      <td>182904</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Track acess</td>
      <td>260307</td>
      <td>33509</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Lumiere</td>
      <td>223554</td>
      <td>70262</td>
    </tr>
  </tbody>
</table>
</div>

<h1 id="since-there-are-too-many-null-values-regarding-track-material-acess-type-and-presence-of-ligtht-lets-explore-track-type-and-track-direction">Since there are too many null values regarding track material, acess type and presence of ligtht, let’s explore track type and track direction</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Starting by track type
</span>
<span class="n">pistes_cyclable_type_not_na</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">()]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Number of track types with null values : </span><span class="sh">"</span><span class="p">,</span> <span class="n">pistes_cyclable_type_not_na</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of track types with null values :  0
</code></pre></div></div>

<h2 id="visuzalize-the-top-5-departments-by-accidents-and-extract-the-first-one">Visuzalize the top 5 departments by accidents and extract the first one</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">top5</span> <span class="o">=</span> <span class="n">region_by_accidents_pop2023</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">acc_per_hab</span><span class="sh">'</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">]).</span><span class="nf">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">top5</span><span class="p">[[</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">pop_2023</span><span class="sh">'</span><span class="p">]])</span>
<span class="n">paris</span> <span class="o">=</span> <span class="n">top5</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">paris</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                     nom  pop_2023
36                 Paris   2102650
21          Hautes-Alpes    139942
82        Maine-et-Loire    828269
60       Hautes-Pyrénées    230583
33  Pyrénées-Atlantiques    697899
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>code</th>
      <th>nom</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>total_acc</th>
      <th>pop_2023</th>
      <th>acc_per_hab</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>36</th>
      <td>75</td>
      <td>Paris</td>
      <td>POLYGON ((598781.702 133337.696, 603566.179 13...</td>
      <td>Paris</td>
      <td>5001</td>
      <td>2102650</td>
      <td>2.378427</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">ax</span> <span class="o">=</span> <span class="n">paris</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">white</span><span class="sh">"</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Drop cols with index_ suffix
</span><span class="n">accidents_by_region_and_name</span> <span class="o">=</span> <span class="n">accidents_by_department</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">accidents_by_department</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>
<span class="n">paris</span> <span class="o">=</span> <span class="n">paris</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">paris</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>

<span class="c1"># Intersect tracks with paris
</span><span class="n">region_intersect_track_type</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">pistes_cyclable_type_not_na</span><span class="p">,</span> <span class="n">paris</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">intersects</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Intersect accidents with paris
</span><span class="n">accidents_intersect_type</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">accidents_by_region_and_name</span><span class="p">,</span> <span class="n">paris</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Define a colormap
</span><span class="n">region_intersect_cmap</span> <span class="o">=</span> <span class="n">colors</span><span class="p">.</span><span class="n">LinearSegmentedColormap</span><span class="p">.</span><span class="nf">from_list</span><span class="p">(</span><span class="n">region_intersect_track_type</span><span class="p">[</span><span class="sh">"</span><span class="s">ame_d</span><span class="sh">"</span><span class="p">].</span><span class="nf">unique</span><span class="p">(),</span> <span class="nf">list</span><span class="p">(</span><span class="nf">reversed</span><span class="p">([</span><span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">yellow</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">orange</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">])))</span>

<span class="n">region_intersect_track_type</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">turbo</span><span class="sh">'</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">accidents_intersect_type</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_54_1.png" alt="png" /></p>

<h1 id="there-doesnt-seem-to-have-a-direct-relation-between-accidents-and-track-type-lets-see-about-the-track-direction">There doesnt seem to have a direct relation between accidents and track type. Lets see about the track direction</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Starting by track type
</span>
<span class="n">pistes_cyclable_direction_not_na</span> <span class="o">=</span> <span class="n">pistes_cyclable</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pistes_cyclable</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">notnull</span><span class="p">()]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Number of track types with null values : </span><span class="sh">"</span><span class="p">,</span> <span class="n">pistes_cyclable_direction_not_na</span><span class="p">[</span><span class="sh">'</span><span class="s">ame_d</span><span class="sh">'</span><span class="p">].</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of track types with null values :  0
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Intersect tracks with paris
</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">paris</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">white</span><span class="sh">"</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">region_intersect_track_direction</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">pistes_cyclable_direction_not_na</span><span class="p">,</span> <span class="n">paris</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">intersects</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Intersect accidents with paris
</span><span class="n">accidents_intersect_track_direction</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">accidents_by_region_and_name</span><span class="p">,</span> <span class="n">paris</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Define a colormap
</span><span class="n">region_intersect_cmap</span> <span class="o">=</span> <span class="n">colors</span><span class="p">.</span><span class="n">LinearSegmentedColormap</span><span class="p">.</span><span class="nf">from_list</span><span class="p">(</span><span class="n">region_intersect_track_direction</span><span class="p">[</span><span class="sh">"</span><span class="s">sens_d</span><span class="sh">"</span><span class="p">].</span><span class="nf">unique</span><span class="p">(),</span> <span class="nf">list</span><span class="p">(</span><span class="nf">reversed</span><span class="p">([</span><span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">])))</span>

<span class="n">region_intersect_track_direction</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="sh">'</span><span class="s">sens_d</span><span class="sh">'</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">region_intersect_cmap</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">accidents_intersect_track_direction</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="sh">"</span><span class="s">age</span><span class="sh">"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>


</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\Projects\venvs\work2\lib\site-packages\geopandas\plotting.py:658: UserWarning: Only specify one of 'column' or 'color'. Using 'color'.
  warnings.warn(





&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_57_2.png" alt="png" /></p>

<h1 id="accidents-by-period-of-the-year">Accidents by period of the year</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">months</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">accidents_intersect_track_direction</span><span class="p">[</span><span class="sh">'</span><span class="s">mois</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()).</span><span class="n">sort</span>
<span class="n">months_order</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">janvier</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">février</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mars</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avril</span><span class="sh">'</span><span class="p">,</span>
          <span class="sh">'</span><span class="s">mai</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">juin</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">juillet</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">août</span><span class="sh">'</span><span class="p">,</span>
          <span class="sh">'</span><span class="s">septembre</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">octobre</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">novembre</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">décembre</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accidents_intersect_track_direction_grouped</span> <span class="o">=</span> <span class="n">accidents_intersect_track_direction</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">mois</span><span class="sh">'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">mois</span><span class="sh">'</span><span class="p">).</span><span class="nf">size</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span><span class="sh">'</span><span class="s">Accidents</span><span class="sh">'</span><span class="p">)</span>

<span class="n">accidents_intersect_track_direction_sorted_grouped</span> <span class="o">=</span> <span class="n">accidents_intersect_track_direction_grouped</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">mois</span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">months_order</span><span class="p">.</span><span class="n">index</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">accidents_intersect_track_direction_sorted_grouped</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mois</th>
      <th>Accidents</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>janvier</td>
      <td>359</td>
    </tr>
    <tr>
      <th>1</th>
      <td>février</td>
      <td>319</td>
    </tr>
    <tr>
      <th>2</th>
      <td>mars</td>
      <td>409</td>
    </tr>
    <tr>
      <th>3</th>
      <td>avril</td>
      <td>391</td>
    </tr>
    <tr>
      <th>4</th>
      <td>mai</td>
      <td>452</td>
    </tr>
    <tr>
      <th>5</th>
      <td>juin</td>
      <td>623</td>
    </tr>
    <tr>
      <th>6</th>
      <td>juillet</td>
      <td>519</td>
    </tr>
    <tr>
      <th>7</th>
      <td>août</td>
      <td>295</td>
    </tr>
    <tr>
      <th>8</th>
      <td>septembre</td>
      <td>507</td>
    </tr>
    <tr>
      <th>9</th>
      <td>octobre</td>
      <td>449</td>
    </tr>
    <tr>
      <th>10</th>
      <td>novembre</td>
      <td>360</td>
    </tr>
    <tr>
      <th>11</th>
      <td>décembre</td>
      <td>318</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">set_theme</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">accidents_intersect_track_direction_sorted_grouped</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">mois</span><span class="sh">"</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">Accidents</span><span class="sh">'</span><span class="p">).</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Accidents per month in paris</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelrotation</span> <span class="o">=</span> <span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_61_0.png" alt="png" /></p>

<h1 id="its-cleaar-that-population-has-a-hight-weight-on-the-bicycle--since-during-the-month-june-and-july-we-have-a-incresed-number-of-tourists-in-paris-the-month-of-september-is-the-first-after-vaccation-in-france">It’s cleaar that population has a hight weight on the bicycle , since during the month June and July, we have a incresed number of tourists in Paris. The month of September, is the first after vaccation in France</h1>

<h2 id="lets-make-cloroplets-using-arrondissement-zones-in-paris">Let’s make cloroplets, using arrondissement zones in paris</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">geoplot</span> <span class="k">as</span> <span class="n">gplt</span>


<span class="c1"># Read polygons of arrondissement
</span><span class="n">arrondis_gdf</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="sh">"</span><span class="s">../data/arrondissements.geojson</span><span class="sh">"</span><span class="p">)</span>
<span class="n">arrondis_gdf</span> <span class="o">=</span> <span class="n">arrondis_gdf</span><span class="p">.</span><span class="nf">to_crs</span><span class="p">(</span><span class="sh">'</span><span class="s">epsg:27561</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Drop cols with index_ suffix
#paris_accidents = paris_accidents.loc[:,~paris_accidents.columns.str.startswith('index_')]
</span>
<span class="c1"># Extract only accidents in paris (by name)
</span><span class="n">paris_accidents</span> <span class="o">=</span> <span class="n">accidents_by_department</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">accidents_by_department</span><span class="p">[</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Paris</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># Merge paris accidents with population data and remove cols with index_ (from merge result)
</span><span class="n">paris_accidents_by_pop2023</span> <span class="o">=</span> <span class="n">paris_accidents</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">population_filtered</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">nom</span><span class="sh">'</span><span class="p">)</span>
<span class="n">paris_accidents_by_pop2023</span> <span class="o">=</span> <span class="n">paris_accidents_by_pop2023</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">paris_accidents_by_pop2023</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>

<span class="c1"># Spatial join between arrondissement (polygon) and  accidents in paris (points), using 'intersects predicate
</span><span class="n">paris_arrondis_accidents_by_pop2023</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">arrondis_gdf</span><span class="p">,</span> <span class="n">paris_accidents_by_pop2023</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">intersects</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Group by arronsidement names and merge with popsulation
</span><span class="n">population_by_arrondissement</span> <span class="o">=</span> <span class="n">paris_arrondis_accidents_by_pop2023</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">l_ar</span><span class="sh">'</span><span class="p">).</span><span class="nf">size</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">num_accidents</span><span class="sh">'</span><span class="p">)</span>
<span class="n">paris_accidents_by_pop2023_arrondi</span> <span class="o">=</span> <span class="n">paris_arrondis_accidents_by_pop2023</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">population_by_arrondissement</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">l_ar</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Ploting result
</span><span class="n">ax</span> <span class="o">=</span> <span class="n">arrondis_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">white</span><span class="sh">"</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="sh">'</span><span class="s">num_accidents</span><span class="sh">'</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">region_intersect_cmap</span><span class="p">.</span><span class="nf">reversed</span><span class="p">(),</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Plot arrondissement labels based on polygons centroids
</span><span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ax</span><span class="p">.</span><span class="nf">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="sh">'</span><span class="s">l_ar</span><span class="sh">'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">centroid</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Number of accidents by arrondissement</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_64_0.png" alt="png" /></p>

<h2 id="and-plot-data">And plot data</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Order by accident
</span><span class="n">population_by_arrondissement_ordered</span> <span class="o">=</span> <span class="n">population_by_arrondissement</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">num_accidents</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Split X axis labels to extract first word
</span><span class="n">labels</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">population_by_arrondissement_ordered</span><span class="p">[</span><span class="sh">'</span><span class="s">l_ar</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

<span class="c1"># Define an axis with plot and its parameters
</span><span class="n">ax</span> <span class="o">=</span> <span class="n">population_by_arrondissement</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">num_accidents</span><span class="sh">'</span><span class="p">).</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">l_ar</span><span class="sh">'</span><span class="p">,</span>
                                                               <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Arrondisement</span><span class="sh">"</span><span class="p">,</span>
                                                               <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Number of accidents</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># Plot
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_66_0.png" alt="png" /></p>

<h3 id="they-are-not-so-representative-since-we-cant-see-where-are-the-zones-where-accidents-occur-more-ofter-lets-make-a-grid-a-greate-function-can-be-found-here--httpspygisiodocse_summarize_vectorhtml">They are not so representative, since we cant see where are the zones where accidents occur more ofter. Lets make a grid. A greate function can be found here : https://pygis.io/docs/e_summarize_vector.html</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">math</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">box</span>

<span class="k">def</span> <span class="nf">create_grid</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Create a grid consisting of either rectangles or hexagons with a specified side length that covers the extent of input feature.</span><span class="sh">'''</span>

    <span class="c1"># Slightly displace the minimum and maximum values of the feature extent by creating a buffer
</span>    <span class="c1"># This decreases likelihood that a feature will fall directly on a cell boundary (in between two cells)
</span>    <span class="c1"># Buffer is projection dependent (due to units)
</span>    <span class="n">feature</span> <span class="o">=</span> <span class="n">feature</span><span class="p">.</span><span class="nf">buffer</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Get extent of buffered input feature
</span>    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">feature</span><span class="p">.</span><span class="n">total_bounds</span>

    <span class="c1"># Shape area
</span>    <span class="n">area</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c1"># Create empty list to hold individual cells that will make up the grid
</span>    <span class="n">cells_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create grid of squares if specified
</span>    <span class="k">if</span> <span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">square</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rectangle</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">box</span><span class="sh">"</span><span class="p">]:</span>

        <span class="c1"># Adapted from https://james-brennan.github.io/posts/fast_gridding_geopandas/
</span>        <span class="c1"># Create and iterate through list of x values that will define column positions with specified side length
</span>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>

            <span class="c1"># Create and iterate through list of y values that will define row positions with specified side length
</span>            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">min_y</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>

                <span class="c1"># Create a box with specified side length and append to list
</span>                <span class="n">cells_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">))</span>
        <span class="n">est</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="nf">length</span><span class="p">(</span><span class="n">cells_list</span><span class="p">)</span>
        <span class="n">north</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="nf">length</span><span class="p">(</span><span class="n">cells_list</span><span class="p">)</span>
        <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="n">est</span> <span class="o">*</span> <span class="n">north</span><span class="p">)</span>

    <span class="c1"># Otherwise, create grid of hexagons
</span>    <span class="k">elif</span> <span class="n">shape</span> <span class="o">==</span> <span class="sh">"</span><span class="s">hexagon</span><span class="sh">"</span><span class="p">:</span>

        <span class="c1"># Set horizontal displacement that will define column positions with specified side length (based on normal hexagon)
</span>        <span class="n">x_step</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">side_length</span>

        <span class="c1"># Set vertical displacement that will define row positions with specified side length (based on normal hexagon)
</span>        <span class="c1"># This is the distance between the centers of two hexagons stacked on top of each other (vertically)
</span>        <span class="n">y_step</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">side_length</span>

        <span class="c1"># Get apothem (distance between center and midpoint of a side, based on normal hexagon)
</span>        <span class="n">apothem</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">side_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Set column number
</span>        <span class="n">column_number</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Create and iterate through list of x values that will define column positions with vertical displacement
</span>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">x_step</span><span class="p">,</span> <span class="n">x_step</span><span class="p">):</span>

            <span class="c1"># Create and iterate through list of y values that will define column positions with horizontal displacement
</span>            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">y_step</span><span class="p">,</span> <span class="n">y_step</span><span class="p">):</span>

                <span class="c1"># Create hexagon with specified side length
</span>                <span class="n">hexagon</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">60</span><span class="p">)]</span>

                <span class="c1"># Append hexagon to list
</span>                <span class="n">cells_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Polygon</span><span class="p">(</span><span class="n">hexagon</span><span class="p">))</span>

            <span class="c1"># Check if column number is even
</span>            <span class="k">if</span> <span class="n">column_number</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># If even, expand minimum and maximum y values by apothem value to vertically displace next row
</span>                <span class="c1"># Expand values so as to not miss any features near the feature extent
</span>                <span class="n">min_y</span> <span class="o">-=</span> <span class="n">apothem</span>
                <span class="n">max_y</span> <span class="o">+=</span> <span class="n">apothem</span>

            <span class="c1"># Else, odd
</span>            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Revert minimum and maximum y values back to original
</span>                <span class="n">min_y</span> <span class="o">+=</span> <span class="n">apothem</span>
                <span class="n">max_y</span> <span class="o">-=</span> <span class="n">apothem</span>

            <span class="c1"># Increase column number by 1
</span>            <span class="n">column_number</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">area</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="nf">pow</span><span class="p">(</span><span class="n">side_length</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Else, raise error
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">Specify a rectangle or hexagon as the grid shape.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Create grid from list of cells
</span>    <span class="n">grid</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">cells_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">geometry</span><span class="sh">'</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="sh">"</span><span class="s">epsg:27561</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Create a column that assigns each grid a number
</span>    <span class="n">grid</span><span class="p">[</span><span class="sh">"</span><span class="s">Grid_ID</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

    <span class="c1"># Return grid
</span>    <span class="k">return</span> <span class="n">grid</span><span class="p">,</span><span class="n">area</span>
</code></pre></div></div>

<h3 id="create-hexagons">Create hexagons</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create heaxagon
</span><span class="n">area_grid</span><span class="p">,</span><span class="n">area</span> <span class="o">=</span> <span class="nf">create_grid</span><span class="p">(</span><span class="n">feature</span> <span class="o">=</span> <span class="n">paris_arrondis_accidents_by_pop2023</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="sh">'</span><span class="s">hexagon</span><span class="sh">'</span><span class="p">,</span> <span class="n">side_length</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
<span class="c1">#cell_grid["cell_id"] = cell_grid.index + 1
#cell_grid.head(5)
</span><span class="n">area_grid</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_70_1.png" alt="png" /></p>

<h3 id="remove-cells-outside-paris">Remove cells outside Paris</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">area_grid_paris</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">area_grid</span><span class="p">,</span> <span class="n">arrondis_gdf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">inner</span><span class="sh">'</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">intersects</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Remove fields from spatial join
</span><span class="n">area_grid_paris</span> <span class="o">=</span> <span class="n">area_grid_paris</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">area_grid_paris</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>
<span class="n">area_grid_paris</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">area_grid_paris</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_72_1.png" alt="png" /></p>

<h3 id="later-we-fuse-the-cells-with-the-accidents-layer">Later, we fuse the cells with the accidents layer</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Remove index columns from previous merge operations, if necessary
</span>
<span class="n">paris_accidents</span> <span class="o">=</span> <span class="n">paris_accidents</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">paris_accidents</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>
<span class="n">paris_accidents_by_pop2023_arrondi</span> <span class="o">=</span> <span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Dataframes have columns with name index ? :</span><span class="sh">"</span><span class="p">,</span> <span class="nf">any</span><span class="p">(</span><span class="n">paris_accidents</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">))</span> 
                                                      <span class="ow">and</span> <span class="nf">any</span><span class="p">(</span><span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dataframes have columns with name index ? : False
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Grab all dataset of accidents, within paris
</span><span class="n">accidents_paris</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">accidents_by_region_and_name</span><span class="p">,</span> <span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">inner</span><span class="sh">'</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>
<span class="n">accidents_paris</span> <span class="o">=</span> <span class="n">accidents_paris</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">accidents_paris</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>
<span class="n">accidents_paris</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">accidents_paris</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">_left</span><span class="sh">"</span><span class="p">)</span>
<span class="n">accidents_paris</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">accidents_paris</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s">_right</span><span class="sh">"</span><span class="p">)</span>

<span class="n">accidents_paris</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
</code></pre></div></div>

<p><img src="../../img/bike/output_75_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accidents_paris</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>num_acc</th>
      <th>da</th>
      <th>an</th>
      <th>mois</th>
      <th>jou</th>
      <th>hrmn</th>
      <th>dep</th>
      <th>com</th>
      <th>la</th>
      <th>lon</th>
      <th>...</th>
      <th>choc</th>
      <th>manv</th>
      <th>vehiculeid</th>
      <th>typevehicules</th>
      <th>manoeuvehicules</th>
      <th>numvehicules</th>
      <th>code</th>
      <th>nom</th>
      <th>pop_2023</th>
      <th>num_accidents</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>65402</th>
      <td>201800041647</td>
      <td>2018-01-13</td>
      <td>2018</td>
      <td>janvier</td>
      <td>samedi</td>
      <td>21:10</td>
      <td>94</td>
      <td>94069</td>
      <td>48.817260</td>
      <td>2.458920</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>202100048294A01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>75</td>
      <td>Paris</td>
      <td>2102650</td>
      <td>375</td>
    </tr>
    <tr>
      <th>65858</th>
      <td>201800054676</td>
      <td>2018-03-06</td>
      <td>2018</td>
      <td>mars</td>
      <td>mardi</td>
      <td>95:0</td>
      <td>75</td>
      <td>75120</td>
      <td>48.846600</td>
      <td>2.415980</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>202100048294A01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>75</td>
      <td>Paris</td>
      <td>2102650</td>
      <td>375</td>
    </tr>
    <tr>
      <th>67693</th>
      <td>201900035012</td>
      <td>2019-06-23</td>
      <td>2019</td>
      <td>juin</td>
      <td>dimanche</td>
      <td>08:10</td>
      <td>75</td>
      <td>75112</td>
      <td>48.844343</td>
      <td>2.441665</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>202100048294A01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>75</td>
      <td>Paris</td>
      <td>2102650</td>
      <td>375</td>
    </tr>
    <tr>
      <th>70147</th>
      <td>202000019957</td>
      <td>2020-12-19</td>
      <td>2020</td>
      <td>décembre</td>
      <td>samedi</td>
      <td>17:15</td>
      <td>94</td>
      <td>94033</td>
      <td>48.844350</td>
      <td>2.450700</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>202100048294A01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>75</td>
      <td>Paris</td>
      <td>2102650</td>
      <td>375</td>
    </tr>
    <tr>
      <th>72628</th>
      <td>202100021295</td>
      <td>2021-09-02</td>
      <td>2021</td>
      <td>septembre</td>
      <td>jeudi</td>
      <td>08:45</td>
      <td>75</td>
      <td>75112</td>
      <td>48.818409</td>
      <td>2.451584</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>202100048294A01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>75</td>
      <td>Paris</td>
      <td>2102650</td>
      <td>375</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 94 columns</p>
</div>

<h2 id="aggreate-accidents-by-cell-grid">Aggreate accidents by cell grid</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#######
# Perform spatial join, merging attribute table of wells point and that of the cell with which it intersects
# op = "intersects" also counts those that fall on a cell boundary (between two cells)
# op = "within" will not count those fall on a cell boundary
</span>
<span class="n">points_within</span> <span class="o">=</span> <span class="n">points_within</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">points_within</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">index_</span><span class="sh">'</span><span class="p">)]</span>

<span class="c1"># Merging accidents data with grid data by spatial intersection boundary
</span><span class="n">grid_accidents</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">points_within</span><span class="p">,</span> <span class="n">area_grid_paris</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Add a field with constant value of 1
</span><span class="n">grid_accidents</span><span class="p">[</span><span class="sh">'</span><span class="s">n_acc</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Compute stats per grid cell -- aggregate fires to grid cells with dissolve
</span><span class="n">dissolve</span> <span class="o">=</span> <span class="n">grid_accidents</span><span class="p">.</span><span class="nf">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">"</span><span class="s">index_right</span><span class="sh">"</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># put this into cell
</span><span class="n">area_grid_paris</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dissolve</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="sh">'</span><span class="s">n_acc</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dissolve</span><span class="p">.</span><span class="n">n_acc</span><span class="p">.</span><span class="n">values</span>

<span class="c1"># Fill the NaN values (cells without any points) with 0 if we want to see
</span><span class="n">area_grid_paris</span><span class="p">[</span><span class="sh">'</span><span class="s">n_acc</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">area_grid_paris</span><span class="p">[</span><span class="sh">'</span><span class="s">n_acc</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#cell_grid = cell_grid.within(paris_accidents_by_pop2023_arrondi)]
</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot data
</span><span class="n">ax</span> <span class="o">=</span> <span class="n">paris_accidents_by_pop2023_arrondi</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">markersize</span><span class="o">=</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">None</span><span class="sh">"</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">legend_intervals</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">area_grid_paris</span><span class="p">[</span><span class="sh">"</span><span class="s">n_acc</span><span class="sh">"</span><span class="p">].</span><span class="nf">min</span><span class="p">()),</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="nf">int</span><span class="p">(</span><span class="n">area_grid_paris</span><span class="p">[</span><span class="sh">"</span><span class="s">n_acc</span><span class="sh">"</span><span class="p">].</span><span class="nf">max</span><span class="p">())]</span>
<span class="n">accidents_paris</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span><span class="n">marker</span> <span class="o">=</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">dimgray</span><span class="sh">'</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">area_grid_paris</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="sh">"</span><span class="s">n_acc</span><span class="sh">"</span><span class="p">,</span> 
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="sh">"</span><span class="s">lightseagreen</span><span class="sh">"</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span><span class="n">legend</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span>
                    <span class="sh">"</span><span class="s">shrink</span><span class="sh">"</span><span class="p">:.</span><span class="mi">68</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">format</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">%g</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">Accidents</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">pad</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="c1">#"ticks" : legend_intervals
</span>                <span class="p">})</span>
<span class="c1"># Set title
</span><span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Grid of accidents per ±</span><span class="si">{</span><span class="n">area</span><span class="si">:</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="s"> m2</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">fontsize</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">15</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">fontweight</span><span class="sh">'</span> <span class="p">:</span> <span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">})</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="../../img/bike/output_79_0.png" alt="png" /></p>

<h1 id="lets-test-some-interpolation-methods-to-fill-the-empty-cells-and-get-better-results">Lets test some interpolation methods to fill the empty cells and get better results</h1>

<h2 id="give-a-small-subset-of-points-to-train-on">Give a small subset of points to train on</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Function to be approximated by polynomial interpolation.</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">samples</span> <span class="o">=</span> <span class="n">area_grid_paris</span><span class="p">[</span><span class="sh">"</span><span class="s">n_acc</span><span class="sh">"</span><span class="p">].</span><span class="nf">to_list</span><span class="p">()</span>

<span class="c1"># whole range we want to plot
</span><span class="n">x_plot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>

<span class="c1"># To make it interesting, we only give a small subset of points to train on.
</span><span class="n">x_train</span> <span class="o">=</span>  <span class="n">samples</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nc">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">rng</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="nf">f</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

<span class="c1"># create 2D-array versions of these arrays to feed to transformers
</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">X_plot</span> <span class="o">=</span> <span class="n">x_plot</span><span class="p">[:,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="n">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="n">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="n">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span><span class="p">,</span> <span class="n">SplineTransformer</span>

<span class="c1"># plot function
</span><span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_prop_cycle</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">teal</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yellowgreen</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gold</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">darkorange</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tomato</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="nf">f</span><span class="p">(</span><span class="n">x_plot</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">ground truth</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># plot training points
</span><span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">training points</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># polynomial features
</span><span class="k">for</span> <span class="n">degree</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nf">make_pipeline</span><span class="p">(</span><span class="nc">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="p">),</span> <span class="nc">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_plot</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_plot</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">degree </span><span class="si">{</span><span class="n">degree</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># B-spline with 4 + 3 - 1 = 6 basis functions
</span><span class="n">model</span> <span class="o">=</span> <span class="nf">make_pipeline</span><span class="p">(</span><span class="nc">SplineTransformer</span><span class="p">(</span><span class="n">n_knots</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="nc">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">y_plot</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_plot</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">B-spline</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">"</span><span class="s">lower center</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div>

<p><img src="../../img/bike/output_84_0.png" alt="png" /></p>

<h3 id="splines-make-a-good-job-on-fitting-well-the-data-and-provide-the-same-time-some-paramenters-to-control-extrapolation-however-seasonal-effects-may-cut-an-expected-periodic-continuation-of-the-underlying-signal-periodic-splines-could-be-used-in-such-case">Splines make a good job on fitting well the data, and provide the same time, some paramenters to control extrapolation. However, seasonal effects may cut an expected periodic continuation of the underlying signal. Periodic splines could be used in such case</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Function to be approximated by periodic spline interpolation.</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">y_train</span> <span class="o">=</span> <span class="nf">g</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

<span class="c1"># Extend the test data into the future:
</span><span class="n">x_plot_ext</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">X_plot_ext</span> <span class="o">=</span> <span class="n">x_plot_ext</span><span class="p">[:,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_prop_cycle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tomato</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">teal</span><span class="sh">"</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x_plot_ext</span><span class="p">,</span> <span class="nf">g</span><span class="p">(</span><span class="n">x_plot_ext</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">ground truth</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">training points</span><span class="sh">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="p">(</span><span class="nc">SplineTransformer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_knots</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="sh">"</span><span class="s">spline</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">(</span>
        <span class="nc">SplineTransformer</span><span class="p">(</span>
            <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">knots</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">10</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">],</span>
            <span class="n">extrapolation</span><span class="o">=</span><span class="sh">"</span><span class="s">periodic</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="sh">"</span><span class="s">periodic spline</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nf">make_pipeline</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="nc">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_plot_ext</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_plot_ext</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x_plot_ext</span><span class="p">,</span> <span class="n">y_plot_ext</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\a815362\AppData\Local\Temp\ipykernel_16436\4214459259.py:30: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.show()
</code></pre></div></div>

<p><img src="../../img/bike/output_87_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="p">.</span><span class="nf">displot</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">kde</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Number of accidents per cell grid in Paris</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:\Projects\venvs\work2\lib\site-packages\seaborn\axisgrid.py:118: UserWarning: The figure layout has changed to tight
  self._figure.tight_layout(*args, **kwargs)





Text(0.5, 1.0, 'Number of accidents per cell grid in Paris')
</code></pre></div></div>

<p><img src="../../img/bike/output_88_2.png" alt="png" /></p>]]></content><author><name>Paulo Pimenta</name></author><category term="Spatial data" /><category term="Data visualization" /><summary type="html"><![CDATA[You’ll find this post in your _posts directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different ways, but the most common way is to run jekyll serve, which launches a web server and auto-regenerates your site when a file is updated.]]></summary></entry></feed>